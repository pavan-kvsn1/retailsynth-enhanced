# Parameter Tier Classification for Calibration

**Total Parameters**: 52  
**Date**: November 6, 2024  
**Purpose**: Classify parameters by calibratability from Dunnhumby transaction data

---

## ğŸ¯ **Classification Criteria**

### **Tier 1: Directly Calibratable** (Observable Effect)
- Parameters that **directly affect** observable distributions in transaction data
- Can be tuned by Optuna to match Dunnhumby distributions
- **Action**: Tune with Optuna

### **Tier 2: Indirectly Calibratable** (Aggregate Effect)
- Parameters that affect distributions through **aggregate mechanisms**
- Can be tuned but with **less certainty** about individual values
- **Action**: Tune with Optuna (with caution)

### **Tier 3: Not Calibratable** (No Observable Effect)
- Parameters with **no observable effect** on transaction distributions
- Cannot be inferred from Dunnhumby data (no demographics, no personalities)
- **Action**: Fix at sensible defaults from domain knowledge/literature

---

## ğŸ“Š **Tier 1: Directly Calibratable (15 parameters)**

### **Observable Distributions We Can Match**:
- âœ… Basket size distribution
- âœ… Revenue distribution
- âœ… Visit frequency distribution
- âœ… Time between visits
- âœ… Quantity distribution

### **Parameters** (15 total):

#### 1. Visit Behavior (1 parameter)
```python
base_visit_probability: float = 0.15
```
**Why Tier 1**: Directly affects visit frequency distribution  
**Optuna Range**: 0.05 - 0.30

---

#### 2. Basket Size (1 parameter)
```python
basket_size_lambda: float = 5.5
```
**Why Tier 1**: Directly affects basket size distribution  
**Optuna Range**: 3.0 - 12.0

---

#### 3. Quantity Distribution (3 parameters)
```python
quantity_mean: float = 1.5
quantity_std: float = 0.8
quantity_max: int = 10
```
**Why Tier 1**: Directly affects quantity distribution  
**Optuna Range**: 
- mean: 1.2 - 2.5
- std: 0.5 - 1.5
- max: 5 - 15

---

#### 4. Temporal Dynamics (2 parameters)
```python
inventory_depletion_rate: float = 0.1
replenishment_threshold: float = 0.3
```
**Why Tier 1**: Directly affects time between visits  
**Optuna Range**:
- depletion_rate: 0.05 - 0.20
- threshold: 0.2 - 0.5

---

#### 5. Basket Composition (3 parameters)
```python
complement_probability: float = 0.4
substitute_avoidance: float = 0.8
category_diversity_weight: float = 0.3
```
**Why Tier 1**: Affects basket coherence and category distribution  
**Optuna Range**:
- complement: 0.2 - 0.7
- substitute: 0.6 - 0.95
- diversity: 0.1 - 0.6

---

#### 6. Purchase History Weights (5 parameters)
```python
loyalty_weight: float = 0.3
habit_weight: float = 0.4
inventory_weight: float = 0.5
variety_weight: float = 0.2
price_memory_weight: float = 0.1
```
**Why Tier 1**: Affects repeat purchase patterns and temporal dynamics  
**Optuna Range**:
- loyalty: 0.1 - 0.6
- habit: 0.2 - 0.7
- inventory: 0.3 - 0.8
- variety: 0.1 - 0.5
- price_memory: 0.05 - 0.3

---

## ğŸ“Š **Tier 2: Indirectly Calibratable (8 parameters)**

### **Why Tier 2**: 
These affect distributions through **aggregate effects** but individual values are hard to pin down.

### **Parameters** (8 total):

#### 1. Promotion Response (3 parameters)
```python
promotion_sensitivity_mean: float = 0.5
promotion_sensitivity_std: float = 0.2
promotion_quantity_boost: float = 1.5
```
**Why Tier 2**: Affects revenue and quantity on promoted items (if we have promo flags in Dunnhumby)  
**Optuna Range**:
- mean: 0.3 - 0.7
- std: 0.1 - 0.3
- boost: 1.2 - 2.0

---

#### 2. Store Loyalty (4 parameters)
```python
store_loyalty_weight: float = 0.6
store_switching_probability: float = 0.15
distance_weight: float = 0.4
satisfaction_weight: float = 0.6
```
**Why Tier 2**: Affects store choice patterns (if we have store_id in Dunnhumby)  
**Optuna Range**:
- loyalty: 0.4 - 0.8
- switching: 0.05 - 0.30
- distance: 0.2 - 0.6
- satisfaction: 0.4 - 0.8

---

#### 3. Customer Drift (1 parameter)
```python
drift_rate: float = 0.05
```
**Why Tier 2**: Affects long-term preference changes (hard to measure)  
**Optuna Range**: 0.01 - 0.15

**Note**: `drift_probability` removed from tuning (too uncertain)

---

## ğŸ“Š **Tier 3: Not Calibratable (29 parameters)**

### **Why Tier 3**: 
Dunnhumby data has **NO** demographics, personalities, or trip purposes. These cannot be inferred reliably.

### **Parameters** (29 total):

#### 1. Customer Demographics (15 parameters)
```python
# Customer mix (4 params)
price_anchor_customers: float = 0.25
convenience_customers: float = 0.25
planned_customers: float = 0.30
impulse_customers: float = 0.20

# Age distribution (5 params)
age_values: List[int] = [25, 35, 45, 55, 65]
age_probabilities: List[float] = [0.2, 0.25, 0.25, 0.2, 0.1]

# Household size (5 params)
household_sizes: List[int] = [1, 2, 3, 4, 5]
household_size_probs: List[float] = [0.28, 0.35, 0.16, 0.15, 0.06]

# Income distributions (3 sets = 10 params, but counted as 3 groups)
young_income_probs: List[float] = [0.35, 0.4, 0.25]
middle_income_probs: List[float] = [0.25, 0.35, 0.25, 0.15]
senior_income_probs: List[float] = [0.4, 0.4, 0.2]

# Children (4 params)
children_probs: List[float] = [0.3, 0.35, 0.25, 0.1]
single_probability: float = 0.3
```
**Why Tier 3**: No demographic data in Dunnhumby  
**Action**: Use census data or retail research defaults

---

#### 2. Personality-Based Parameters (8 parameters)
```python
# Visit probability by personality (4 params)
visit_prob_by_personality: Dict[str, float] = {
    'price_anchor': 0.12,
    'convenience': 0.18,
    'planned': 0.15,
    'impulse': 0.20
}

# Brand loyalty by personality (4 params)
brand_loyalty_by_personality: Dict[str, float] = {
    'price_anchor': 0.3,
    'convenience': 0.7,
    'planned': 0.6,
    'impulse': 0.4
}
```
**Why Tier 3**: No personality labels in Dunnhumby  
**Action**: Use retail research defaults (e.g., Ailawadi & Keller 2004)

---

#### 3. Price Sensitivity by Personality (4 parameters)
```python
price_sensitivity_by_personality: Dict[str, float] = {
    'price_anchor': 0.9,
    'convenience': 0.2,
    'planned': 0.5,
    'impulse': 0.4
}
```
**Why Tier 3**: No personality labels in Dunnhumby  
**Action**: Use retail research defaults

---

#### 4. Price Sensitivity by Income (5 parameters)
```python
price_sensitivity_by_income: Dict[str, float] = {
    '<30K': 0.8,
    '30-50K': 0.6,
    '50-75K': 0.4,
    '75-100K': 0.3,
    '>100K': 0.2
}
```
**Why Tier 3**: No income data in Dunnhumby  
**Action**: Use economic research defaults

---

#### 5. Trip Purpose Parameters (8 parameters)
```python
# Basket size by trip (4 params)
basket_size_by_trip: Dict[str, float] = {
    'quick_trip': 3.0,
    'major_shop': 12.0,
    'fill_in': 6.0,
    'special_occasion': 8.0
}

# Trip purpose weights (4 params)
trip_purpose_weights: Dict[str, float] = {
    'quick_trip': 0.3,
    'major_shop': 0.4,
    'fill_in': 0.2,
    'special_occasion': 0.1
}
```
**Why Tier 3**: No trip purpose labels in Dunnhumby  
**Action**: Use retail research defaults (e.g., Sorensen 2009)

---

#### 6. Brand Loyalty Aggregate (2 parameters)
```python
brand_loyalty_mean: float = 0.6
brand_loyalty_std: float = 0.2
```
**Why Tier 3**: These are overridden by personality-specific values  
**Action**: Keep as fallback defaults

---

## ğŸ“Š **Summary**

| Tier | Count | Action | Rationale |
|------|-------|--------|-----------|
| **Tier 1** | 15 | **Tune with Optuna** | Direct observable effect |
| **Tier 2** | 8 | **Tune with caution** | Indirect/aggregate effect |
| **Tier 3** | 29 | **Fix at defaults** | No observable effect |
| **Total** | **52** | | |


---

## ğŸ“Š **Impact Matrix**

**Question**: Which parameters affect which metrics? How much overlap is there?

| Parameter | Basket Size | Revenue | Visit Freq | Quantity | Primary Effect |
|-----------|-------------|---------|------------|----------|----------------|
| **Visit Behavior** |
| `base_visit_probability` | âŒ | âŒ | âœ…âœ…âœ… | âŒ | Visit freq only |
| **Basket Size** |
| `basket_size_lambda` | âœ…âœ…âœ… | âœ…âœ… | âŒ | âŒ | Basket size, revenue |
| **Quantity** |
| `quantity_mean` | âŒ | âœ… | âŒ | âœ…âœ…âœ… | Quantity, revenue |
| `quantity_std` | âŒ | âœ… | âŒ | âœ…âœ… | Quantity variance |
| `quantity_max` | âŒ | âœ… | âŒ | âœ…âœ… | Quantity cap |
| **Temporal Dynamics** |
| `inventory_depletion_rate` | âœ… | âœ… | âœ… | âŒ | All (repeat purchases) |
| `replenishment_threshold` | âœ… | âœ… | âœ… | âŒ | All (repeat purchases) |
| **Basket Composition** |
| `complement_probability` | âœ…âœ… | âœ…âœ… | âŒ | âŒ | Basket size, revenue |
| `substitute_avoidance` | âœ… | âœ… | âŒ | âŒ | Basket diversity |
| `category_diversity_weight` | âœ… | âœ… | âŒ | âŒ | Basket diversity |
| **Purchase History** |
| `loyalty_weight` | âœ… | âœ… | âœ… | âŒ | All (repeat behavior) |
| `habit_weight` | âœ… | âœ… | âœ… | âŒ | All (repeat behavior) |
| `inventory_weight` | âœ… | âœ… | âœ… | âŒ | All (repeat behavior) |
| `variety_weight` | âœ… | âœ… | âŒ | âŒ | Basket diversity |
| `price_memory_weight` | âœ… | âœ…âœ… | âŒ | âŒ | Revenue (price sensitivity) |

**Legend**:
- âœ…âœ…âœ… = Primary effect (90%+ impact)
- âœ…âœ… = Strong effect (50-90% impact)
- âœ… = Moderate effect (10-50% impact)
- âŒ = Minimal/no effect (<10% impact)

---

## ğŸš€ **Recommended Calibration Strategy**

### **Phase 1: Tune Tier 1 Parameters (High Priority)**
```bash
python scripts/tune_parameters_optuna.py \
    --real-data data/raw/dunnhumby/transaction_data.csv \
    --tier 1 \
    --n-trials 50 \
    --output outputs/tuning_tier1
```
**Expected**: Good fit on basket size, revenue, visit frequency

---

### **Phase 2: Tune Tier 2 Parameters (Medium Priority)**
```bash
python scripts/tune_parameters_optuna.py \
    --real-data data/raw/dunnhumby/transaction_data.csv \
    --tier 2 \
    --n-trials 30 \
    --output outputs/tuning_tier2
```
**Expected**: Marginal improvement on promotion response, store loyalty

---

### **Phase 3: Fix Tier 3 Parameters (Low Priority)**
- Use retail research literature
- Use census data for demographics
- Use domain expert knowledge
- **Do NOT tune** - no observable effect

---

## ğŸ“š **Literature Sources for Tier 3 Defaults**

1. **Customer Personalities**: Ailawadi & Keller (2004), "Understanding Retail Branding"
2. **Trip Purposes**: Sorensen (2009), "Inside the Mind of the Shopper"
3. **Demographics**: US Census Bureau, American Community Survey
4. **Price Sensitivity**: Tellis (1988), "The Price Elasticity of Selective Demand"
5. **Brand Loyalty**: Ehrenberg (1988), "Repeat-Buying: Facts, Theory and Applications"

---

## ğŸ¯ **Next Steps**

1. âœ… **Refactor `tune_parameters_optuna.py`** to only tune Tier 1 & 2 parameters
2. âœ… **Create `config_defaults.py`** with literature-based Tier 3 defaults
3. âœ… **Add `--tier` flag** to Optuna script for selective tuning
4. âœ… **Document rationale** for each Tier 3 default value
5. âœ… **Run calibration** and measure improvement

---

**Bottom Line**: We should tune **23 parameters** (Tier 1 + Tier 2), not all 52. The other 29 should be fixed at sensible defaults from domain knowledge.
